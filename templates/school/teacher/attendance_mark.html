{% extends 'school/teacher/base.html' %}
{% load custom_filters %}
{% block title %}Attendance | {{ school.name }}{% endblock %}

{% block content %}
<style>
.status-pill {
    padding: 6px 12px;
    border-radius: 20px;
    border: 2px solid transparent;
    cursor: pointer;
    font-weight: 600;
}
.status-selected {
    border-color: #00000040;
    background-color: #00000008;
}
</style>

<section class="container-fluid py-4">
    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-white border-bottom d-flex justify-content-between">
            <div>
                <h5 class="fw-bold mb-1">Mark Attendance</h5>
                <small class="text-muted">
                    {{ lesson.subject.name }} • {{ lesson.lesson_date|date:"M d, Y" }}
                </small>
            </div>
            <span class="badge bg-primary-subtle text-primary px-3 py-2">
                {{ enrollments|length }} Students
            </span>
        </div>

        <div class="card-body">
            {% if enrollments %}
            <form method="POST">
                {% csrf_token %}

                <div class="table-responsive">
                    <table class="table table-bordered align-middle">
                        <thead class="table-light text-center">
                            <tr>
                                <th class="text-start">Student</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enrollment in enrollments %}
                            {% with att=attendance_dict|dict_get:enrollment.id %}
                            <tr data-enrollment="{{ enrollment.id }}">
                                <td>
                                    <strong>{{ enrollment.student.user.get_full_name }}</strong><br>
                                    <small class="text-muted">ID: {{ enrollment.student.student_id }}</small>
                                </td>
                                <td class="text-center">
                                    {% for choice in status_choices %}
                                    <label class="status-pill {{ choice.color_class }}">
                                        <input type="radio"
                                               class="form-check-input status-radio"
                                               name="status_{{ enrollment.id }}"
                                               value="{{ choice.code }}"
                                               data-enrollment="{{ enrollment.id }}"
                                               data-label="{{ choice.label }}"
                                               {% if att and att.status == choice.code %}checked{% endif %}
                                               {% if not att and choice.code == 'P' %}checked{% endif %}>
                                        {{ choice.code }}
                                    </label>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-success btn-lg px-5">
                        Smart Attendance
                    </button> 
                    <button type="submit" class="btn btn-success btn-lg px-5">
                        Save Attendance
                    </button>
                </div>
            </form>
            {% else %}
                <div class="text-center text-muted py-5">
                    No students enrolled for this lesson.
                </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- ───────────────── MODAL ───────────────── -->
<div class="modal fade" id="disciplineModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4">
            <div class="modal-header">
                <h5 class="modal-title">Discipline Record Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Student:</strong> <span id="modalStudent"></span></p>
                <p><strong>Status:</strong> <span id="modalStatus"></span></p>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Description *</label>
                    <textarea id="modalDescription" class="form-control" rows="3"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Severity</label>
                    <select id="modalSeverity" class="form-select">
                        <option value="minor">Minor</option>
                        <option value="major">Major</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Action Taken</label>
                    <textarea id="modalAction" class="form-control" rows="2"></textarea>
                </div>

                <input type="hidden" id="modalEnrollment">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="saveDiscipline">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- ───────────── Hidden discipline fields ───────────── -->
{% for enrollment in enrollments %}
<input type="hidden" name="description_{{ enrollment.id }}" id="desc_{{ enrollment.id }}">
<input type="hidden" name="severity_{{ enrollment.id }}" id="sev_{{ enrollment.id }}">
<input type="hidden" name="action_{{ enrollment.id }}" id="act_{{ enrollment.id }}">
{% endfor %}

<script>
const seriousStatuses = ['IB', '18', '20'];
let activeRadio = null;

document.querySelectorAll('.status-radio').forEach(radio => {
    radio.addEventListener('change', function () {
        if (!seriousStatuses.includes(this.value)) return;

        activeRadio = this;
        const row = this.closest('tr');
        const student = row.querySelector('strong').textContent;

        document.getElementById('modalStudent').textContent = student;
        document.getElementById('modalStatus').textContent = this.dataset.label;
        document.getElementById('modalEnrollment').value = this.dataset.enrollment;

        document.getElementById('modalDescription').value = '';
        document.getElementById('modalAction').value = '';
        document.getElementById('modalSeverity').value = 'minor';

        new bootstrap.Modal(
            document.getElementById('disciplineModal')
        ).show();
    });
});

document.getElementById('saveDiscipline').onclick = () => {
    const id = document.getElementById('modalEnrollment').value;
    const desc = document.getElementById('modalDescription').value.trim();

    if (!desc) {
        alert('Description is required');
        return;
    }

    document.getElementById(`desc_${id}`).value = desc;
    document.getElementById(`sev_${id}`).value =
        document.getElementById('modalSeverity').value;
    document.getElementById(`act_${id}`).value =
        document.getElementById('modalAction').value;

    bootstrap.Modal.getInstance(
        document.getElementById('disciplineModal')
    ).hide();
};

document.getElementById('disciplineModal')
.addEventListener('hidden.bs.modal', () => {
    const id = document.getElementById('modalEnrollment').value;
    if (activeRadio && !document.getElementById(`desc_${id}`).value) {
        activeRadio.checked = false;
    }
    activeRadio = null;
});
</script>
{% endblock %}
