{% extends 'school/teacher/base.html' %}
{% load dic_filters timetable_filters %}

{% block title %}Teacher Dashboard | {{ school.name }}{% endblock %}

{% block content %}
<section class="bg-light py-4">
    <div class="container">
        <!-- Top Cards -->
        <div class="row g-4">
            <!-- Today's Lessons -->
            <div class="col-6 col-md-3">
                <div class="card k-card">
                    <div class="card-body d-flex justify-content-between align-items-center p-3">
                        <div>
                            <div class="text-secondary small">Today's Lessons</div>
                            <div class="h4 m-0 fw-bold">{{ today_lessons.count|default:"0" }}</div>
                        </div>
                        <a href="#today-lessons" class="k-pill"><i class="bi bi-eye"></i> View</a>
                    </div>
                </div>
            </div>

            <!-- Assigned Students -->
            <div class="col-6 col-md-3">
                <div class="card k-card">
                    <div class="card-body d-flex justify-content-between align-items-center p-3">
                        <div>
                            <div class="text-secondary small">Assigned Students</div>
                            <div class="h4 m-0 fw-bold">{{ lessons|length|default:"0" }}</div>
                        </div>
                        <a href="#" class="k-pill"><i class="bi bi-eye"></i> Manage</a>
                    </div>
                </div>
            </div>

            <!-- Upcoming Sessions -->
            <div class="col-6 col-md-3">
                <div class="card k-card">
                    <div class="card-body d-flex justify-content-between align-items-center p-3">
                        <div>
                            <div class="text-secondary small">Upcoming Sessions</div>
                            <div class="h4 m-0 fw-bold">{{ sessions.count|default:"0" }}</div>
                        </div>
                        <a href="#" class="k-pill"><i class="bi bi-eye"></i> View</a>
                    </div>
                </div>
            </div>

            <!-- My Subjects -->
            <div class="col-6 col-md-3">
                <div class="card k-card">
                    <div class="card-body d-flex justify-content-between align-items-center p-3">
                        <div>
                            <div class="text-secondary small">My Subjects</div>
                            <div class="h4 m-0 fw-bold">{{ subjects|length|default:"0" }}</div>
                        </div>
                        <a href="#" class="k-pill"><i class="bi bi-eye"></i> Edit</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Lessons Table -->
        <div class="row mt-4" id="today-lessons">
            <div class="col-12">
                <h5 class="fw-semibold mb-3">Today's Lessons</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Subject</th>
                                <th>Grade</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lesson in today_lessons %}
                            <tr>
                                <td>{{ lesson.lesson_date|date:"M d" }} : {{ lesson.time_slot.start_time }} - {{ lesson.time_slot.end_time }}</td>
                                <td>{{ lesson.subject.name }}</td>
                                <td>{{ lesson.timetable.grade.name }}</td>
                                <td>
                                    <a href="{% url 'school:teacher-attendance-mark' lesson.id %}" class="btn btn-sm btn-success">Mark</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No lessons today.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Weekly Timetable -->
        {% if timetable %}
        <div class="row mt-4">
            <div class="col-12">
                <h5 class="fw-semibold mb-3">Weekly Timetable (All Lessons)</h5>
                <div class="table-responsive">
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Time Slot</th>
                                {% for day in week_days %}
                                    <th>{{ day|date:"D M d" }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in time_slots %}
                            <tr>
                                <td>{{ slot.start_time }} - {{ slot.end_time }}</td>
                                {% for day in week_days %}
                                    <td class="p-1">
                                        {% get_lessons_for_slot_day timetable slot day as lessons_for_cell %}
                                        {% if lessons_for_cell %}
                                            {% for lesson in lessons_for_cell %}
                                                <div class="bg-primary text-white p-2 rounded mb-1">
                                                    <div class="fw-bold">{{ lesson.subject.name }}</div>
                                                    <div>Room: {{ lesson.room|default:"N/A" }}</div>
                                                                                        <a href="{% url 'school:teacher-attendance-mark' lesson.id %}" class="btn btn-sm btn-success">Mark</a>

                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-muted">-</div>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}
