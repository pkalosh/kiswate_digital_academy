{% extends "school/student/base.html" %}
{% load dict_filters %}

{% block title %}Student Dashboard{% endblock %}

{% block content %}

<style>
html, body { overflow-x: hidden; }

.profile-card {
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}

.stat-card {
  border-radius: 10px;
  transition: transform 0.12s ease, box-shadow 0.12s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
}

.stat-icon { font-size: 2.1rem; margin-bottom: 0.6rem; }

.heatmap-day {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  font-weight: bold;
  color: white;
}

.heatmap-day.present  { background: #198754; }
.heatmap-day.late     { background: #ffc107; color: #212529; }
.heatmap-day.absent   { background: #dc3545; }

.filter-form .form-control,
.filter-form .form-select,
.filter-form .btn { height: 42px; }

.lesson-card {
  border-radius: 8px;
  padding: 0.65rem 0.9rem;
  margin-bottom: 0.5rem;
  font-size: 0.92rem;
  background: #e8f5e9;
  border-left: 4px solid #28a745;
  color: #1b5e20;
}

.lesson-card small { opacity: 0.9; }

.timetable-card .card-header {
  background: #f1f5f9;
  font-weight: 600;
  color: #334155;
}

@media (max-width: 767.98px) {
  .desktop-timetable { display: none !important; }
  .mobile-timetable  { display: block !important; }
  .heatmap-day { width: 42px; height: 42px; font-size: 1rem; }
}

@media (min-width: 768px) {
  .mobile-timetable { display: none !important; }
  .desktop-timetable { display: block !important; }
}
</style>

<div class="container py-4">

  <!-- Fee Balance Warning -->
  {% if student.fee_balance > 0 %}
  <div class="alert alert-danger d-flex flex-column flex-sm-row justify-content-between align-items-center gap-3 mb-4" role="alert">
    <div>
      <strong>Fee Balance Alert:</strong><br>
      Outstanding balance: <strong>{{ student.fee_balance }}</strong>
    </div>
    <a href="{% url 'student:fees' %}" class="btn btn-light btn-sm px-4">Pay Now</a>
  </div>
  {% endif %}

  <div class="row mb-4 g-3">

    <!-- Profile -->
    <div class="col-md-4">
      <div class="card profile-card border-0 h-100">
        <div class="card-body">
          <h5 class="fw-bold mb-1">{{ student.user.get_full_name }}</h5>
          <div class="text-muted small mb-3">Adm No: {{ student.student_id }}</div>
          <hr class="my-3">
          <p class="mb-2"><strong>Grade:</strong> {{ grade.name|default:"—" }}</p>
          <p class="mb-2"><strong>Class:</strong> {{ student.stream.name|default:"—" }}</p>
          <p class="mb-2"><strong>Parent:</strong> {% for p in student.parents.all %}{{ p.user.get_full_name }}, {% endfor %}</p>
          <p class="mb-2"><strong>Contact:</strong> {% for p in student.parents.all %}{{ p.user.phone_number }}, {% endfor %}</p>
        </div>
      </div>
    </div>

    <!-- Stats + Heatmap -->
    <div class="col-md-8">
      <div class="row g-3 mb-4">
        {% for stat in stats %}
        <div class="col-6 col-sm-6 col-md-3">
          <a href="{{ stat.url }}" class="text-decoration-none">
            <div class="card stat-card text-center h-100">
              <div class="card-body py-3">
                <i class="bi {{ stat.icon }} stat-icon text-{{ stat.color }}"></i>
                <div class="small text-muted mt-1">{{ stat.title }}</div>
                <div class="h4 fw-bold mt-1">{{ stat.value }}</div>
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>

      <h6 class="fw-bold mb-2">This Week's Attendance</h6>
      <div class="d-flex flex-wrap gap-3 mb-4 justify-content-start">
        {% for day in heatmap %}
        <div class="text-center">
          <div class="heatmap-day {{ day.status }}">
            {{ day.status|slice:":1"|upper|default:"?" }}
          </div>
          <small class="text-muted mt-1 d-block">{{ day.date|date:"D" }}</small>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="row g-2 mb-4 filter-form">
    <div class="col-6 col-md-3">
      <input type="date" name="date" class="form-control" value="{{ request.GET.date }}">
    </div>
    <div class="col-6 col-md-3">
      <select name="subject" class="form-select">
        <option value="">All Subjects</option>
        {% for s in subjects %}
        <option value="{{ s.id }}" {% if request.GET.subject == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-4">
      <select name="teacher" class="form-select">
        <option value="">All Teachers</option>
        {% for t in teachers %}
        <option value="{{ t.id }}" {% if request.GET.teacher == t.id|stringformat:"s" %}selected{% endif %}>
          {{ t.user.get_full_name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <!-- Mobile timetable -->
  <div class="mobile-timetable">
    {% for slot in time_slots %}
    <div class="card mb-3 shadow-sm border-0 rounded-3 timetable-card">
      <div class="card-header text-center py-2 fw-bold">
        {{ slot.start_time|time:"H:i" }} – {{ slot.end_time|time:"H:i" }}
      </div>
      <div class="card-body p-3">
        {% for day_tuple in weekdays %}
        <div class="mb-3">
          <h6 class="{% if day_tuple.0 == today_weekday %}text-primary fw-bold{% else %}text-muted{% endif %} mb-2 border-bottom pb-1">
            {{ day_tuple.1 }}
          </h6>
          {% with lessons=timetable_grid|get_item:day_tuple.0|get_item:slot.id %}
            {% if lessons %}
              {% for lesson in lessons %}
              <div class="lesson-card">
                <strong>{{ lesson.subject.name }}</strong>
                <div class="small mt-1">{{ lesson.teacher.user.get_full_name|truncatechars:28 }}</div>
              </div>
              {% endfor %}
            {% else %}
              <small class="text-muted fst-italic">No lesson</small>
            {% endif %}
          {% endwith %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% empty %}
    <div class="alert alert-info text-center py-4">No time slots defined</div>
    {% endfor %}
  </div>

  <!-- Desktop timetable -->
  <div class="desktop-timetable table-responsive">
    <table class="table table-bordered text-center align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="min-width: 100px;">Time</th>
          {% for day_tuple in weekdays %}
          <th class="{% if day_tuple.0 == today_weekday %}bg-success-subtle{% endif %}">
            {{ day_tuple.1 }}
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for slot in time_slots %}
        <tr>
          <td class="fw-semibold">
            {{ slot.start_time|time:"H:i" }}<br>
            <small class="text-muted">{{ slot.end_time|time:"H:i" }}</small>
          </td>
          {% for day_tuple in weekdays %}
          <td class="p-2 {% if day_tuple.0 == today_weekday %}bg-success-subtle{% endif %}">
            {% with lessons=timetable_grid|get_item:day_tuple.0|get_item:slot.id %}
              {% if lessons %}
                {% for lesson in lessons %}
                <div class="lesson-card">
                  <strong>{{ lesson.subject.name }}</strong><br>
                  <small>{{ lesson.teacher.user.get_full_name|truncatechars:20 }}</small>
                </div>
                {% endfor %}
              {% else %}
                <span class="text-muted small">—</span>
              {% endif %}
            {% endwith %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% endblock %}