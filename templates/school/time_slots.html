{% extends 'school/base.html' %}
{% block title %}Time Slots | {{ school.name }}{% endblock %}
{% block content %}
<header class="header d-flex align-items-center justify-content-between mb-3">
  <div>
    <h6 class="m-0 fw-bold">Time Slots</h6>
    <nav aria-label="breadcrumb" class="small">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'school:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Time Slots</li>
      </ol>
    </nav>
  </div>
  <div>
    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#timeSlotModal" data-mode="create">
      <i class="bi bi-plus"></i> Add Time Slot
    </button>
  </div>
</header>

<!-- Messages (for form errors/success) -->
{% if messages %}
<div class="row mb-3">
  {% for message in messages %}
  <div class="col-12">
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<section class="content container-fluid">
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Description</th>
              <th>Created By</th>
              <th>Updated By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for slot in slots %}
            <tr>
              <td>{{ slot.start_time|time:"H:i" }}</td>
              <td>{{ slot.end_time|time:"H:i" }}</td>
              <td>{{ slot.description|default:"-" }}</td>
              <td>{{ slot.created_by.user.get_full_name|default:"System" }}</td>
              <td>{{ slot.updated_by.user.get_full_name|default:"-" }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#timeSlotModal"
                        data-mode="edit"
                        data-id="{{ slot.id }}"
                        data-start="{{ slot.start_time|time:'H:i' }}"
                        data-end="{{ slot.end_time|time:'H:i' }}"
                        data-description="{{ slot.description|default:'' }}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        data-id="{{ slot.id }}"
                        data-description="{{ slot.description|default:'N/A' }}">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">No time slots found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- Create / Edit Modal -->
<div class="modal fade" id="timeSlotModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="timeSlotModalTitle">Add Time Slot</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="timeSlotForm">
        {% csrf_token %}
        <div class="modal-body">
          <!-- Non-field errors (if form passed from view) -->
          {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {{ form.non_field_errors }}
          </div>
          {% endif %}

          <!-- Preferred: Use Django form fields for auto-errors/widgets -->
          {% if form %}
          <div class="mb-3">
            {{ form.start_time.label_tag }}
            {{ form.start_time }}
            {% if form.start_time.errors %}
            <div class="invalid-feedback d-block">{{ form.start_time.errors }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ form.end_time.label_tag }}
            {{ form.end_time }}
            {% if form.end_time.errors %}
            <div class="invalid-feedback d-block">{{ form.end_time.errors }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ form.description.label_tag }}
            {{ form.description }}
            {% if form.description.errors %}
            <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
            {% endif %}
          </div>
          {% else %}
          <!-- Fallback: Raw inputs (add this if not passing form) -->
          <div class="mb-3">
            <label for="id_start_time" class="form-label">Start Time <span class="text-danger">*</span></label>
            <input type="time" name="start_time" id="id_start_time" class="form-control" required step="900">  <!-- step=15min -->
            <div class="invalid-feedback" id="start_time_errors"></div>
          </div>
          <div class="mb-3">
            <label for="id_end_time" class="form-label">End Time <span class="text-danger">*</span></label>
            <input type="time" name="end_time" id="id_end_time" class="form-control" required step="900">
            <div class="invalid-feedback" id="end_time_errors"></div>
          </div>
          <div class="mb-3">
            <label for="id_description" class="form-label">Description</label>
            <input type="text" name="description" id="id_description" class="form-control" placeholder="Optional description" maxlength="100">
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Time Slot</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="deleteForm">
        {% csrf_token %}
        <div class="modal-body">
          <p>Are you sure you want to delete this time slot: <strong id="deleteDescription"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const timeSlotModal = document.getElementById('timeSlotModal');
  const timeSlotForm = document.getElementById('timeSlotForm');
  const modalTitle = document.getElementById('timeSlotModalTitle');

  timeSlotModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const mode = button.dataset.mode;
    if (mode === "create") {
      modalTitle.textContent = "Add Time Slot";
      timeSlotForm.action = "{% url 'school:time-slot-create' %}";
      timeSlotForm.reset();
      clearErrors();
    } else if (mode === "edit") {
      modalTitle.textContent = "Edit Time Slot";
      const slotId = button.dataset.id;
      timeSlotForm.action = "{% url 'school:time-slot-edit' 0 %}".replace("0", slotId);
      document.getElementById("id_start_time").value = button.dataset.start;
      document.getElementById("id_end_time").value = button.dataset.end;
      document.getElementById("id_description").value = button.dataset.description || '';
      clearErrors();
    }
  });

  // Client-side validation (time-specific)
  timeSlotForm.addEventListener('submit', function (e) {
    const startInput = document.getElementById('id_start_time');
    const endInput = document.getElementById('id_end_time');
    if (!startInput || !endInput) return;  // Skip if using form fields
    clearErrors();

    let isValid = true;
    if (!startInput.value) {
      showError('start_time_errors', 'Start time is required.');
      isValid = false;
    }
    if (!endInput.value) {
      showError('end_time_errors', 'End time is required.');
      isValid = false;
    }
    if (startInput.value && endInput.value) {
      const start = new Date(`2000-01-01T${startInput.value}:00`);
      const end = new Date(`2000-01-01T${endInput.value}:00`);
      if (end <= start) {
        showError('end_time_errors', 'End time must be after start time.');
        isValid = false;
      }
    }

    if (!isValid) {
      e.preventDefault();
      return false;
    }
  });

  function showError(errorId, message) {
    const errorEl = document.getElementById(errorId);
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.parentElement.classList.add('is-invalid');
    }
  }

  function clearErrors() {
    ['start_time_errors', 'end_time_errors'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = '';
        el.parentElement.classList.remove('is-invalid');
      }
    });
  }

  // Delete handler (unchanged)
  const deleteModal = document.getElementById('deleteModal');
  const deleteForm = document.getElementById('deleteForm');
  if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const slotId = button.dataset.id;
      deleteForm.action = "{% url 'school:time-slot-delete' 0 %}".replace("0", slotId);
      document.getElementById('deleteDescription').textContent = button.dataset.description;
    });
  }
});
</script>
{% endblock %}