{% extends 'school/base.html' %}
{% block title %}Timetables | {{ school.name }}{% endblock %}

{% block content %}
<header class="header d-flex align-items-center justify-content-between">
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-sm btn-dark d-lg-none" id="toggleSidebar"><i class="bi bi-list"></i></button>
    <div>
      <h6 class="m-0 fw-bold">Timetables</h6>
      <nav aria-label="breadcrumb" class="small">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="{% url 'school:dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item active" aria-current="page">Timetables</li>
        </ol>
      </nav>
    </div>
  </div>
  <div class="d-flex align-items-center gap-2">
    <form method="get" class="d-inline">
      <div class="input-group input-group-sm" style="width: 250px;">
        <input type="text" name="q" class="form-control" placeholder="Search timetables..." value="{{ query }}">
        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
      </div>
    </form>
    <button class="btn btn-sm btn-outline-dark"><i class="bi bi-bell"></i></button>
  </div>
</header>

<section class="content container-fluid py-4">
  {% if messages %}
    <div class="row">
      {% for message in messages %}
        <div class="col-12">
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Timetables ({{ timetables|length }})</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#timetableModal" data-mode="create">
          <i class="bi bi-plus"></i> Add Timetable
        </button>
        <a href="#" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#exportModal">Export</a>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Grade</th>
              <th>Term</th>
              <th>Year</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Created At</th>
              <th>Lessons</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in timetables %}
            <tr data-bs-toggle="collapse" data-bs-target="#lessons-{{ item.timetable.id }}" class="clickable">
                <td>{{ item.timetable.grade.name }}</td>
                <td>Term {{ item.timetable.term }}</td>
                <td>{{ item.timetable.year }}</td>
                <td>{{ item.timetable.start_date }}</td>
                <td>{{ item.timetable.end_date }}</td>
                <td>{{ item.timetable.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ item.lessons_count }} Lessons</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#timetableModal"
                            data-mode="edit"
                            data-id="{{ item.timetable.id }}"
                            data-grade="{{ item.timetable.grade.id }}"
                            data-term="{{ item.timetable.term }}"
                            data-year="{{ item.timetable.year }}"
                            data-start_date="{{ item.timetable.start_date }}"
                            data-end_date="{{ item.timetable.end_date }}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal"
                            data-id="{{ item.timetable.id }}"
                            data-name="Term {{ item.timetable.term }} - {{ item.timetable.grade.name }}">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#lessonModal"
                            data-mode="create" data-timetable="{{ item.timetable.id }}">
                        <i class="bi bi-plus"></i> Add Lesson
                    </button>
                </td>
            </tr>

            <!-- Lessons collapse -->
            <tr class="collapse bg-light" id="lessons-{{ item.timetable.id }}">
                <td colspan="8">
                    <table class="table table-sm table-borderless mb-0">
                        <thead>
                            <tr class="text-muted small">
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Teacher</th>
                                <th>Time</th>
                                <th>Room</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lesson in item.lessons %}
                            <tr>
                                <td>{{ lesson.date }}</td>
                                <td>{{ lesson.subject.name }}</td>
                                <td>{{ lesson.teacher.user.get_full_name }}</td>
                                <td>{{ lesson.start_time }} - {{ lesson.end_time }}</td>
                                <td>{{ lesson.room }}</td>
                                <td>
                                    {% if lesson.is_canceled %}
                                        <span class="badge bg-danger">Canceled</span>
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#lessonModal"
                                            data-mode="edit" data-id="{{ lesson.id }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#lessonDeleteModal"
                                            data-id="{{ lesson.id }}"
                                            data-name="{{ lesson.subject.name }} on {{ lesson.date }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center text-muted py-2">No lessons added yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Timetable Modal -->
  <div class="modal fade" id="timetableModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="timetableModalTitle">Add Timetable</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" id="timetableForm" action="{% url 'school:timetable-create' %}">
          {% csrf_token %}
          <input type="hidden" name="mode" id="mode" value="create">
          <div class="modal-body">
            {% for field in form %}
              <div class="mb-3">
                {{ field.label_tag }}
                {{ field }}
                {% if field.errors %}
                  <div class="text-danger small">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Lesson Modal -->
  <div class="modal fade" id="lessonModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="lessonModalTitle">Add Lesson</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" id="lessonForm" action="{% url 'school:lesson-create' %}">
          {% csrf_token %}
          <input type="hidden" name="mode" id="lessonMode" value="create">
          <input type="hidden" name="timetable" id="lessonTimetable">
          <div class="modal-body">
            {% for field in lesson_form %}
              <div class="mb-3">
                {{ field.label_tag }}
                {{ field }}
                {% if field.errors %}
                  <div class="text-danger small">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save Lesson</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Lesson Delete Modal -->
  <div class="modal fade" id="lessonDeleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Lesson</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" id="lessonDeleteForm">
          {% csrf_token %}
          <div class="modal-body">
            <p>Are you sure you want to delete <strong id="deleteLessonName"></strong>? This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Timetable Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Timetable</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" id="deleteForm">
          {% csrf_token %}
          <div class="modal-body">
            <p>Are you sure you want to delete <strong id="deleteName"></strong>? This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export Timetables</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Export as CSV or PDF?</p>
          <a href="#" class="btn btn-outline-primary me-2">CSV</a>
          <a href="#" class="btn btn-outline-secondary">PDF</a>
        </div>
      </div>
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', function () {
    // Timetable modal
    const timetableModal = document.getElementById('timetableModal');
    const timetableForm = document.getElementById('timetableForm');
    const timetableModalTitle = document.getElementById('timetableModalTitle');
    const modeInput = document.getElementById('mode');

    if (timetableModal) {
      timetableModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const mode = button.dataset.mode;
        modeInput.value = mode;

        if (mode === 'create') {
          timetableModalTitle.textContent = 'Add Timetable';
          timetableForm.action = "{% url 'school:timetable-create' %}";
          timetableForm.reset();
        } else if (mode === 'edit') {
          const id = button.dataset.id;
          timetableModalTitle.textContent = 'Edit Timetable';
          const updateUrl = "{% url 'school:timetable-edit' 0 %}".replace('0', id);
          timetableForm.action = updateUrl;

          document.querySelector('#id_grade').value = button.dataset.grade || '';
          document.querySelector('#id_term').value = button.dataset.term || '';
          document.querySelector('#id_year').value = button.dataset.year || '';
          document.querySelector('#id_start_date').value = button.dataset.start_date || '';
          document.querySelector('#id_end_date').value = button.dataset.end_date || '';
        }
      });
    }

    // Delete timetable
    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    if (deleteModal) {
      deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const id = button.dataset.id;
        const name = button.dataset.name;
        document.getElementById('deleteName').textContent = name;
        const deleteUrl = "{% url 'school:timetable-delete' 0 %}".replace('0', id);
        deleteForm.action = deleteUrl;
      });
    }

    // Lesson modal
    const lessonModal = document.getElementById('lessonModal');
    const lessonForm = document.getElementById('lessonForm');
    const lessonModalTitle = document.getElementById('lessonModalTitle');
    const lessonMode = document.getElementById('lessonMode');
    const lessonTimetableInput = document.getElementById('lessonTimetable');

    if (lessonModal) {
      lessonModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const mode = button.dataset.mode;
        lessonMode.value = mode;

        if (mode === 'create') {
          lessonModalTitle.textContent = 'Add Lesson';
          lessonForm.action = "{% url 'school:lesson-create' %}";
          lessonForm.reset();
          if (button.dataset.timetable) {
            lessonTimetableInput.value = button.dataset.timetable;
          }
        } else if (mode === 'edit') {
          const lessonId = button.dataset.id;
          lessonModalTitle.textContent = 'Edit Lesson';
          const updateUrl = "{% url 'school:lesson-edit' 0 %}".replace('0', lessonId);
          lessonForm.action = updateUrl;
        }
      });
    }

    // Lesson delete modal
    const lessonDeleteModal = document.getElementById('lessonDeleteModal');
    const lessonDeleteForm = document.getElementById('lessonDeleteForm');
    if (lessonDeleteModal) {
      lessonDeleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const lessonId = button.dataset.id;
        const lessonName = button.dataset.name;
        document.getElementById('deleteLessonName').textContent = lessonName;
        const deleteUrl = "{% url 'school:lesson-delete' 0 %}".replace('0', lessonId);
        lessonDeleteForm.action = deleteUrl;
      });
    }
});
</script>
</section>
{% endblock %}
