{% extends "school/base.html" %}
{% load sc_filters %}

{% block content %}

<style>
/* ================= KPI CARDS ================= */
.kpi-card {
  background: #ffffff;
  border-radius: 12px;
  padding: 1.25rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  text-align: center;
  height: 100%;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  cursor: default;
}
.kpi-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}
.kpi-icon {
  font-size: 2.5rem;
  margin-bottom: 0.8rem;
}
.kpi-icon.text-success { color: #198754; }
.kpi-icon.text-danger { color: #dc3545; }
.kpi-card h4 { margin-bottom: 0.2rem; font-weight: 600; }
.kpi-card small { font-size: 0.85rem; color: #6c757d; }

/* ================= TIMETABLE ================= */
.timetable-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 1rem; }
.timetable-wrapper table { min-width: 960px; width: 100%; }
.time-cell { position: sticky; left: 0; background: #f1f3f5; font-weight: 600; z-index: 10; min-width: 80px; }
.day-header { position: sticky; top: 0; background: #f8f9fa; z-index: 9; font-weight: 600; }
.today-header { background: #d4edda !important; }
.weekend-header { background: #f8d7da !important; }
.lesson-card { background: #f8f9fa; border-left: 4px solid #198754; padding: 0.7rem; border-radius: 8px; margin-bottom: 0.6rem; font-size: 0.9rem; line-height: 1.35; }
.lesson-card.conflict { border-left-color: #dc3545; background: rgba(220,53,69,0.07); }
.day-label { font-weight: 600; color: #495057; margin-bottom: 0.4rem; padding-bottom: 0.3rem; border-bottom: 1px solid #e9ecef; }

/* Mobile improvements */
@media (max-width: 767px) {
  .kpi-icon { font-size: 2.3rem; }
  .kpi-card { padding: 1rem; }
  .lesson-card { font-size: 0.85rem; padding: 0.6rem; }
  .day-label { font-size: 1rem; }
}
.scroll-hint { font-size: 0.9rem; color: #6c757d; text-align: center; margin: 0.75rem 0 1.25rem; font-style: italic; }
</style>

<div class="container-fluid py-4">

  <!-- ================= KPI CARDS ================= -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-icon text-success"><i class="bi bi-person-badge"></i></div>
        <h4 class="mb-1">{{ total_teachers }}</h4>
        <small class="text-muted">Teachers</small>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-icon text-success"><i class="bi bi-people"></i></div>
        <h4 class="mb-1">{{ total_students }}</h4>
        <small class="text-muted">Students</small>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-icon text-success"><i class="bi bi-person-hearts"></i></div>
        <h4 class="mb-1">{{ total_parents }}</h4>
        <small class="text-muted">Parents</small>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-icon text-danger"><i class="bi bi-shield-exclamation"></i></div>
        <h4 class="mb-1">{{ total_discipline_cases }}</h4>
        <small class="text-muted">Discipline Cases</small>
      </div>
    </div>
  </div>

  <!-- ================= FILTERS ================= -->
  <div class="card shadow-sm border-0 rounded-3 mb-4">
    <div class="card-body">
      <form method="get" class="filter-form row g-3">
        <div class="col-6 col-md-2">
          <select name="grade" class="form-select">
            <option value="">All Grades</option>
            {% for g in grades %}
            <option value="{{ g.id }}" {% if selected_grade == g.id|stringformat:"s" %}selected{% endif %}>{{ g.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select name="stream" class="form-select">
            <option value="">All Streams</option>
            {% for s in streams %}
            <option value="{{ s.id }}" {% if selected_stream == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select name="teacher" class="form-select">
            <option value="">All Teachers</option>
            {% for t in teachers %}
            <option value="{{ t.id }}" {% if selected_teacher == t.id|stringformat:"s" %}selected{% endif %}>{{ t.user.get_full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select name="subject" class="form-select">
            <option value="">All Subjects</option>
            {% for sub in subjects %}
            <option value="{{ sub.id }}" {% if selected_subject == sub.id|stringformat:"s" %}selected{% endif %}>{{ sub.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-2">
          <input type="date" name="date" value="{{ selected_date|date:'Y-m-d' }}" class="form-control">
        </div>
        <div class="col-6 col-md-2 d-grid">
          <button type="submit" class="btn btn-success">
            <i class="bi bi-funnel-fill"></i> Filter
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= WEEK NAVIGATION ================= -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-secondary btn-sm" href="?date={{ prev_week|date:'Y-m-d' }}">← Previous week</a>
    <strong>{{ week_start|date:"M j" }} – {{ week_end|date:"M j, Y" }}</strong>
    <a class="btn btn-outline-secondary btn-sm" href="?date={{ next_week|date:'Y-m-d' }}">Next week →</a>
  </div>

  <!-- ================= MOBILE TIMETABLE ================= -->
  <div class="d-md-none">
    {% for slot in time_slots %}
    <div class="card shadow-sm mb-3 border-0 rounded-3">
      <div class="card-header bg-light fw-bold text-center py-2">
        {{ slot.start_time|time:"H:i" }} – {{ slot.end_time|time:"H:i" }}
      </div>
      <div class="card-body p-3">
        {% for day in week_days %}
        <div class="mb-3">
          <div class="day-label {% if day == today %}text-success{% endif %}">
            {{ day|date:"D, M j" }}
          </div>
          {% with lessons=calendar|get_item:slot.id|get_item:day %}
            {% if lessons %}
              {% for lesson in lessons %}
              <div class="lesson-card {% if lesson.id in conflicts %}conflict{% endif %}">
                <strong>{{ lesson.subject.name }}</strong><br>
                <small class="text-muted">{{ lesson.stream.name }} • {{ lesson.teacher.user.get_full_name|truncatechars:22 }}</small>
              </div>
              {% endfor %}
            {% else %}
              <small class="text-muted fst-italic">No lesson scheduled</small>
            {% endif %}
          {% endwith %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ================= DESKTOP TIMETABLE ================= -->
  <div class="timetable-wrapper d-none d-md-block">
    <table class="table table-bordered align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th class="time-cell text-center">Time</th>
          {% for day in week_days %}
          <th class="day-header text-center {% if day == today %}today-header{% endif %} {% if day|date:'w' in '0,6' %}weekend-header{% endif %}">
            {{ day|date:"D, M j" }}
          </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for slot in time_slots %}
        <tr>
          <td class="time-cell text-center">
            {{ slot.start_time|time:"H:i" }}<br>
            <small class="text-muted">{{ slot.end_time|time:"H:i" }}</small>
          </td>
          {% for day in week_days %}
          <td class="p-2">
            {% with lessons=calendar|get_item:slot.id|get_item:day %}
              {% if lessons %}
                {% for lesson in lessons %}
                <div class="lesson-card {% if lesson.id in conflicts %}conflict{% endif %}">
                  <strong>{{ lesson.subject.name }}</strong><br>
                  <small class="text-muted">{{ lesson.stream.name }} | {{ lesson.teacher.user.get_full_name }}</small>
                </div>
                {% endfor %}
              {% else %}
                <div class="text-center py-2"><small class="text-muted">—</small></div>
              {% endif %}
            {% endwith %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% endblock %}
