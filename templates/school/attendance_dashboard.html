{% extends 'school/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-fluid py-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="fw-bold mb-0">Attendance Intelligence Dashboard</h3>
    <small class="text-muted">Real-time attendance & discipline insights</small>
  </div>
  <a href="{% url 'school:attendance_export_csv' %}" class="btn btn-outline-success">
    <i class="fa fa-file-excel"></i> Export CSV
  </a>
</div>

<!-- ALERTS -->
{% if alerts %}
<div class="alert alert-danger shadow-sm">
  <strong><i class="fa fa-triangle-exclamation"></i> Alerts</strong>
  <ul class="mb-0">
    {% for a in alerts %}
      <li>{{ a }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<!-- FILTER PANEL -->
<form method="get" class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-2">

      <!-- Academic Year -->
      <div class="col-md-2">
        <label class="form-label">Academic Year</label>
        <select name="academic_year" class="form-select">
          <option value="">All</option>
          {% for ay in academic_years %}
          <option value="{{ ay.id }}" {% if filters.academic_year == ay.id|stringformat:"s" %}selected{% endif %}>
            {{ ay.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Term -->
      <div class="col-md-2">
        <label class="form-label">Term</label>
        <select name="term" class="form-select">
          <option value="">All</option>
          {% for t in terms %}
          <option value="{{ t.id }}" {% if filters.term == t.id|stringformat:"s" %}selected{% endif %}>
            {{ t.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Grade -->
      <div class="col-md-2">
        <label class="form-label">Grade</label>
        <select name="grade" id="grade-select" class="form-select">
          <option value="">All</option>
          {% for g in grades %}
          <option value="{{ g.id }}" {% if filters.grade == g.id|stringformat:"s" %}selected{% endif %}>
            {{ g.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Stream -->
      <div class="col-md-2">
        <label class="form-label">Stream</label>
        <select name="stream" id="stream-select" class="form-select">
          <option value="">All</option>
          {% for s in streams %}
          <option value="{{ s.id }}" {% if filters.stream == s.id|stringformat:"s" %}selected{% endif %}>
            {{ s.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Subject -->
      <div class="col-md-2">
        <label class="form-label">Subject</label>
        <select name="subject" class="form-select">
          <option value="">All</option>
          {% for sub in subjects %}
          <option value="{{ sub.id }}" {% if filters.subject == sub.id|stringformat:"s" %}selected{% endif %}>
            {{ sub.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Student -->
      <div class="col-md-2">
        <label class="form-label">Student</label>
        <input type="text" name="student" value="{{ filters.student }}" class="form-control" placeholder="Name / Adm No">
      </div>

      <!-- Date -->
      <div class="col-md-2">
        <label class="form-label">Date</label>
        <input type="date" name="date" value="{{ filters.date }}" class="form-control">
      </div>

      <div class="col-md-2 align-self-end">
        <button class="btn btn-success w-100">
          <i class="fa fa-filter"></i> Apply Filters
        </button>
      </div>

    </div>
  </div>
</form>

<!-- KPI CARDS -->
<div class="row g-3 mb-4">
  <div class="col-xl-3 col-md-6">
    <div class="card shadow border-0 bg-success text-white">
      <div class="card-body">
        <h6 class="text-uppercase">Present</h6>
        <h2>{{ stats.P|default:0 }}</h2>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card shadow border-0 bg-warning text-dark">
      <div class="card-body">
        <h6 class="text-uppercase">Tardy</h6>
        <h2>{{ stats.ET|default:0|add:stats.UT|default:0 }}</h2>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card shadow border-0 bg-danger text-white">
      <div class="card-body">
        <h6 class="text-uppercase">Absent</h6>
        <h2>{{ stats.EA|default:0|add:stats.UA|default:0 }}</h2>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card shadow border-0 bg-info text-white">
      <div class="card-body">
        <h6 class="text-uppercase">Total Records</h6>
        <h2>{{ attendances.paginator.count|intcomma }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- DISCIPLINE -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm border-start border-4 border-warning">
      <div class="card-body">
        <h6>Discipline Incidents</h6>
        <h3>{{ discipline_stats.total|default:0 }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm border-start border-4 border-danger">
      <div class="card-body">
        <h6>Unresolved Cases</h6>
        <h3>{{ discipline_stats.unresolved|default:0 }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm border-start border-4 border-dark">
      <div class="card-body">
        <h6>Severe Incidents</h6>
        <h3>{{ discipline_stats.severe|default:0 }}</h3>
      </div>
    </div>
  </div>
</div>



<!-- CHARTS -->
<div class="row mb-4">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6>Daily Attendance Trend</h6>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6>Absence vs Presence</h6>
        <canvas id="summaryChart"></canvas>
      </div>
    </div>
  </div>
</div>
<!-- ATTENDANCE TABLE -->
<div class="card shadow-sm">
  <div class="card-body table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-success text-center">
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>Grade</th>
          <th>Stream</th>
          <th>Subject</th>
          <th>Date</th>
          <th>Status</th>
          <th>Term</th>
          <th>Year</th>
          <th>Marked By</th>
        </tr>
      </thead>
      <tbody>
        {% for a in attendances %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ a.enrollment.student.user.get_full_name }}</td>
          <td>{{ a.enrollment.student.grade_level.name }}</td>
          <td>{{ a.enrollment.student.stream.name }}</td>
          <td>{{ a.enrollment.subject.name }}</td>
          <td>{{ a.date|date:"d M Y" }}</td>
          <td class="text-center">
            {% if a.status == 'P' %}
              <span class="text-success">✔</span>
            {% elif a.status in 'ET UT' %}
              <span class="text-warning">⏰</span>
            {% elif a.status in 'EA UA' %}
              <span class="text-danger">✖</span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>{{ a.term.name }}</td>
          <td>{{ a.academic_year.name }}</td>
          <td>{{ a.marked_by.user.first_name }} {{ a.marked_by.user.last_name }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-muted">No attendance records found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Grade → Stream AJAX -->
<script>
$('#grade-select').change(function() {
    let grade_id = $(this).val();
    $.get("{% url 'school:get_streams_by_grade' %}", { grade: grade_id }, function(data) {
        let $stream = $('#stream-select');
        $stream.empty().append('<option value="">All</option>');
        data.streams.forEach(s => $stream.append(`<option value="${s.id}">${s.name}</option>`));
    });
});

// Charts
new Chart(document.getElementById('trendChart'), {
  type: 'line',
  data: {
    labels: [{% for d in daily_trend %}'{{ d.date }}',{% endfor %}],
    datasets: [
      { label: 'Present', data: [{% for d in daily_trend %}{{ d.present }},{% endfor %}], borderWidth: 2, borderColor:'green' },
      { label: 'Absent', data: [{% for d in daily_trend %}{{ d.absent }},{% endfor %}], borderWidth: 2, borderColor:'red' }
    ]
  }
});

new Chart(document.getElementById('summaryChart'), {
  type: 'bar',
  data: {
    labels: ['Present','Tardy','Absent'],
    datasets: [{
      data: [
        {{ stats.P|default:0 }},
        {{ stats.ET|default:0|add:stats.UT|default:0 }},
        {{ stats.EA|default:0|add:stats.UA|default:0 }}
      ],
      backgroundColor: ['green','orange','red']
    }]
  }
});
</script>
{% endblock %}
