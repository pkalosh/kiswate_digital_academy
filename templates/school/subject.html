{% extends 'school/base.html' %}
{% block title %}Subjects | {{ school.name }}{% endblock %}

{% block content %}

<style>
@media (max-width: 768px) {
  table.mobile-table thead {
    display: none;
  }
  table.mobile-table tr {
    display: block;
    border-bottom: 1px solid #ddd;
    margin-bottom: 1rem;
  }
  table.mobile-table td {
    display: flex;
    justify-content: space-between;
    padding: .5rem;
  }
  table.mobile-table td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #555;
  }
}
</style>

<header class="header d-flex align-items-center justify-content-between flex-wrap gap-2">
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-sm btn-dark d-lg-none" id="toggleSidebar">
      <i class="bi bi-list"></i>
    </button>
    <div>
      <h6 class="m-0 fw-bold">Subjects</h6>
      <nav aria-label="breadcrumb" class="small">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a href="{% url 'school:dashboard' %}">Dashboard</a>
          </li>
          <li class="breadcrumb-item active">Subjects</li>
        </ol>
      </nav>
    </div>
  </div>

  <form method="get" class="d-flex">
    <div class="input-group input-group-sm">
      <input type="text" name="q" class="form-control"
             placeholder="Search subjects..."
             value="{{ query }}">
      <button class="btn btn-outline-secondary">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </form>
</header>

<section class="content container-fluid py-4">

{% if messages %}
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
    {{ message }}
    <button class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
{% endif %}

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h5 class="mb-0">
      <i class="bi bi-journal-bookmark me-2"></i>
      Subjects ({{ subjects.paginator.count }})
    </h5>

    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-success"
              data-bs-toggle="modal"
              data-bs-target="#subjectModal"
              data-mode="create">
        <i class="bi bi-plus"></i> Add Subject
      </button>

      <button class="btn btn-sm btn-outline-success"
              data-bs-toggle="modal"
              data-bs-target="#exportModal">
        Export
      </button>
    </div>
  </div>

  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover align-middle mobile-table">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Code</th>
            <th>Grade</th>
            <th>Start</th>
            <th>End</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
        {% for subject in subjects %}
          <tr>
            <td data-label="Name"><strong>{{ subject.name }}</strong></td>
            <td data-label="Code"><code>{{ subject.code }}</code></td>
            <td data-label="Grade">{{ subject.grade.name }}</td>
            <td data-label="Start">{{ subject.start_date }}</td>
            <td data-label="End">{{ subject.end_date|default:"-" }}</td>

            <td data-label="Status">
              {% if subject.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>

            <td data-label="Actions">
              <div class="d-flex gap-1">
                <button class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#subjectModal"
                        data-mode="edit"
                        data-id="{{ subject.id }}"
                        data-name="{{ subject.name|escapejs }}"
                        data-code="{{ subject.code|escapejs }}"
                        data-description="{{ subject.description|escapejs }}"
                        data-grade="{{ subject.grade.id }}"
                        data-start_date="{{ subject.start_date }}"
                        data-end_date="{{ subject.end_date }}"
                        data-is_active="{% if subject.is_active %}true{% else %}false{% endif %}">
                  <i class="bi bi-pencil"></i>
                </button>

                <button class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        data-id="{{ subject.id }}"
                        data-name="{{ subject.name|escapejs }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              No subjects found.
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {% if subjects.has_other_pages %}
    <nav class="mt-4">
      <ul class="pagination justify-content-center flex-wrap">

        {% if subjects.has_previous %}
        <li class="page-item">
          <a class="page-link"
             href="?q={{ query }}&page={{ subjects.previous_page_number }}">
            &laquo; Prev
          </a>
        </li>
        {% endif %}

        {% for num in subjects.paginator.page_range %}
          {% if subjects.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% elif num > subjects.number|add:'-3' and num < subjects.number|add:'3' %}
            <li class="page-item">
              <a class="page-link"
                 href="?q={{ query }}&page={{ num }}">
                {{ num }}
              </a>
            </li>
          {% endif %}
        {% endfor %}

        {% if subjects.has_next %}
        <li class="page-item">
          <a class="page-link"
             href="?q={{ query }}&page={{ subjects.next_page_number }}">
            Next &raquo;
          </a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>

<!-- SUBJECT MODAL -->
<div class="modal fade" id="subjectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="subjectModalTitle">Add Subject</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" id="subjectForm" action="{% url 'school:subject-create' %}">
        {% csrf_token %}
        <input type="hidden" name="mode" id="mode">

        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">{{ form.name.label_tag }}{{ form.name }}</div>
            <div class="col-md-6 mb-3">{{ form.code.label_tag }}{{ form.code }}</div>
            <div class="col-md-6 mb-3">{{ form.grade.label_tag }}{{ form.grade }}</div>
            <div class="col-md-6 mb-3">{{ form.start_date.label_tag }}{{ form.start_date }}</div>
            <div class="col-md-6 mb-3">{{ form.end_date.label_tag }}{{ form.end_date }}</div>
            <div class="col-12 mb-3">{{ form.description.label_tag }}{{ form.description }}</div>
            <div class="col-12 form-check">
              {{ form.is_active }} {{ form.is_active.label_tag }}
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Subject</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="deleteForm">
        {% csrf_token %}
        <div class="modal-body">
          Are you sure you want to delete <strong id="deleteName"></strong>?
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- EXPORT MODAL -->
<div class="modal fade" id="exportModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Export Subjects</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <a href="#" class="btn btn-outline-primary me-2">CSV</a>
        <a href="#" class="btn btn-outline-secondary">PDF</a>
      </div>
    </div>
  </div>
</div>

</section>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const subjectModal = document.getElementById('subjectModal');
  const subjectForm = document.getElementById('subjectForm');
  const title = document.getElementById('subjectModalTitle');

  subjectModal.addEventListener('show.bs.modal', e => {
    const btn = e.relatedTarget;
    const mode = btn.dataset.mode;
    document.getElementById('mode').value = mode;

    if (mode === 'create') {
      title.textContent = 'Add Subject';
      subjectForm.action = "{% url 'school:subject-create' %}";
      subjectForm.reset();
    } else {
      title.textContent = 'Edit Subject';
      subjectForm.action =
        "{% url 'school:subject-edit' 0 %}".replace('0', btn.dataset.id);

      id_name.value = btn.dataset.name;
      id_code.value = btn.dataset.code;
      id_description.value = btn.dataset.description;
      id_grade.value = btn.dataset.grade;
      id_start_date.value = btn.dataset.start_date;
      id_end_date.value = btn.dataset.end_date;
      document.querySelector('input[name="is_active"]').checked =
        btn.dataset.is_active === "true";
    }
  });

  const deleteModal = document.getElementById('deleteModal');
  deleteModal.addEventListener('show.bs.modal', e => {
    const btn = e.relatedTarget;
    deleteName.textContent = btn.dataset.name;
    deleteForm.action =
      "{% url 'school:subject-delete' 0 %}".replace('0', btn.dataset.id);
  });

});
</script>

{% endblock %}
