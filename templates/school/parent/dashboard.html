{% extends 'school/parent/base.html' %}
{% load static %}
{% block title %}Parent Dashboard | {{ request.user.get_full_name }}{% endblock %}

{% block content %}
<section class="container-fluid py-4">

<h3 class="mb-4">Welcome, {{ request.user.get_full_name }}</h3>

<div class="accordion" id="schoolAccordion">
    {% for school, students in schools.items %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                {{ school.name }}
                <span class="ms-3">
                    {% for student_data in students %}
                        <span class="badge bg-success me-1">{{ student_data.student.user.get_full_name }} (Grade: {{ student_data.student.grade_level.name }}, Admission No: {{ student_data.student.student_id }})</span>
                    {% endfor %}
                </span>
            </button>
        </h2>
        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#schoolAccordion">
            <div class="accordion-body">

                <!-- Student Tabs -->
                {% if students|length > 1 %}
                <ul class="nav nav-tabs" id="studentTabs{{ forloop.counter }}" role="tablist">
                    {% for student_data in students %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if forloop.first %}active{% endif %}" id="student-tab-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#student-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" type="button" role="tab" aria-controls="student-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                            {{ student_data.student.user.get_full_name }} - {{ student_data.student.grade_level.name }} {{ student_data.student.stream.name }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}

                <div class="tab-content mt-3" id="studentTabsContent{{ forloop.counter }}">
                    {% for student_data in students %}
                    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="student-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" role="tabpanel" aria-labelledby="student-tab-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">

                        <!-- Stats -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-3 col-6">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <i class="bi bi-book-fill fs-3 text-success"></i>
                                        <div class="small text-muted mt-1">Lessons</div>
                                        <div class="h5 fw-bold">{{ student_data.total_lessons }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <i class="bi bi-check-circle-fill fs-3 text-success"></i>
                                        <div class="small text-muted mt-1">Attendance</div>
                                        <div class="h5 fw-bold">{{ student_data.attended }}/{{ student_data.total_lessons }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <i class="bi bi-exclamation-triangle-fill fs-3 text-success"></i>
                                        <div class="small text-muted mt-1">Discipline</div>
                                        <div class="h5 fw-bold">{{ student_data.discipline_count }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Lessons Table -->
                        <h6>Upcoming Lessons (Next 7 Days)</h6>
                        <div class="table-responsive">
                        <table class="table table-sm table-bordered table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Teacher</th>
                                    <th>Time</th>
                                    <th>Room</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lesson in student_data.upcoming_lessons %}
                                <tr>
                                    <td>{{ lesson.lesson_date|date:"M. d, Y" }}</td>
                                    <td>{{ lesson.subject.name }}</td>
                                    <td>{{ lesson.teacher.get_full_name }}</td>
                                    <td>{{ lesson.time_slot.start_time|time:"g:i a" }} - {{ lesson.time_slot.end_time|time:"g:i a" }}</td>
                                    <td>{{ lesson.room }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-muted text-center">No upcoming lessons</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>

                        <!-- Notifications -->
                        <h6 class="mt-3">Notifications</h6>
                        <ul class="list-group">
                            {% for note in student_data.notifications %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ note.title }}
                                {% if note.is_read %}
                                <span class="badge bg-secondary">Read</span>
                                {% else %}
                                <span class="badge bg-success">New</span>
                                {% endif %}
                            </li>
                            {% empty %}
                            <li class="list-group-item text-muted">No notifications</li>
                            {% endfor %}
                        </ul>

                    </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}
